<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dopes Fitness - Pay Now</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; text-align: center; padding: 60px 20px; }
    .btn { padding: 14px 32px; background: #111; color: #fff; border-radius: 5px; border: none; font-size: 1.2em; cursor: pointer; }
    .btn:hover { background: #444; }
  </style>
</head>
<body>
  <h1>Subscribe & Pay</h1>
  <p>Get started with Dopes Fitness subscription!</p>
  <button class="btn" id="payBtn">Pay ₹10</button>

  <script>
    async function createOrderOnServer(amountRupees = 10) {
      const resp = await fetch("https://fitness-app-rl7q.onrender.com/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: amountRupees })
      });
      if (!resp.ok) throw new Error("Create order failed");
      return resp.json();
    }

    async function verifyOnServer(payload) {
      const resp = await fetch("https://fitness-app-rl7q.onrender.com/verify-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      return resp.json();
    }

    document.getElementById("payBtn").onclick = async function (e) {
      e.preventDefault();
      try {
        // 1) create order on server
        const orderResp = await createOrderOnServer(10); // 10 rupees
        if (!orderResp.success) throw new Error("Order creation failed on server");

        // 2) prepare Razorpay options
        const options = {
          key: "rzp_live_RKB5wpngUC57hu", // replace with your key if different
          amount: orderResp.amount,
          currency: orderResp.currency,
          name: "Dopes Fitness",
          description: "Subscription Payment",
          order_id: orderResp.orderId, // use server-provided order id
          handler: async function (razorResponse) {
            // razorResponse contains razorpay_order_id, razorpay_payment_id, razorpay_signature
            // 3) verify payment on server
            const verifyResult = await verifyOnServer(razorResponse);
            if (verifyResult.success) {
              alert("✅ Payment verified and captured!");
            } else {
              alert("❌ Payment verification failed: " + (verifyResult.message || ""));
            }
          },
          modal: {
            ondismiss: function() {
              console.log("Checkout closed");
            }
          }
        };

        const rzpInstance = new Razorpay(options);
        rzpInstance.open();
      } catch (err) {
        console.error(err);
        alert("Payment failed: " + (err.message || err));
      }
    };
  </script>
</body>
</html>
